name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

env:
  BUILD_TYPE: Release

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Detect Prerelease
        id: detect_prerelease
        run: |
          if [[ "${{ github.ref }}" =~ -[a-zA-Z0-9]+ ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Firebird ODBC Driver v${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: ${{ steps.detect_prerelease.outputs.is_prerelease }}
          generate_release_notes: true

  build-windows:
    needs: create-release
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history needed for git describe

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DBUILD_TESTING=OFF -DODBC_OFFICIAL_RELEASE=ON

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Install WiX Toolset
      run: dotnet tool install --global wix

    - name: Build MSI Installer
      shell: pwsh
      run: |
        $version = "${{ needs.create-release.outputs.version }}.0"
        $dllPath = Resolve-Path "build/${{env.BUILD_TYPE}}/FirebirdODBC.dll"

        wix build `
          -d ProductVersion=$version `
          -d DriverPath="$dllPath" `
          -d Configuration=${{env.BUILD_TYPE}} `
          -arch x64 `
          -o "firebird-odbc-driver-${{ needs.create-release.outputs.version }}-win-x64.msi" `
          installer/Product.wxs

    - name: Package Windows ZIP
      shell: pwsh
      run: |
        $packageDir = "package-windows"
        New-Item -ItemType Directory -Path $packageDir -Force | Out-Null

        Copy-Item "build/${{env.BUILD_TYPE}}/FirebirdODBC.dll" -Destination $packageDir
        Copy-Item "build/${{env.BUILD_TYPE}}/FirebirdODBC.lib" -Destination $packageDir -ErrorAction SilentlyContinue
        Copy-Item "README.md" -Destination $packageDir -ErrorAction SilentlyContinue

        Compress-Archive -Path "$packageDir/*" `
          -DestinationPath "firebird-odbc-driver-${{ needs.create-release.outputs.version }}-win-x64.zip"

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          firebird-odbc-driver-${{ needs.create-release.outputs.version }}-win-x64.msi
          firebird-odbc-driver-${{ needs.create-release.outputs.version }}-win-x64.zip

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history needed for git describe

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unixodbc unixodbc-dev firebird-dev

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DBUILD_TESTING=OFF -DODBC_OFFICIAL_RELEASE=ON

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -- -j$(nproc)

    - name: Package Linux Build
      run: |
        packageDir="package-linux"
        mkdir -p "$packageDir"

        cp build/libOdbcFb.so "$packageDir/"

        if [ -f "build/src/IscDbc/libIscDbc.a" ]; then
          cp build/src/IscDbc/libIscDbc.a "$packageDir/"
        fi

        cp README.md "$packageDir/" 2>/dev/null || true

        cat > "$packageDir/odbcinst.ini.sample" << 'EOF'
        [Firebird ODBC Driver]
        Description = Firebird ODBC Driver
        Driver = /usr/local/lib/odbc/libOdbcFb.so
        Setup = /usr/local/lib/odbc/libOdbcFb.so
        FileUsage = 1
        EOF

        cd "$packageDir"
        tar -czf "../firebird-odbc-driver-${{ needs.create-release.outputs.version }}-linux-x64.tar.gz" *

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          firebird-odbc-driver-${{ needs.create-release.outputs.version }}-linux-x64.tar.gz
