name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  BUILD_TYPE: Release

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Firebird ODBC Driver ${{ github.ref }}
          draft: false
          prerelease: false
          body: |
            Release of Firebird ODBC Driver version ${{ steps.get_version.outputs.version }}
            
            ## Downloads
            - Windows x64: `firebird-odbc-driver-windows-x64.zip`
            - Linux x64: `firebird-odbc-driver-linux-x64.tar.gz`
            
            ## Installation
            
            ### Windows
            1. Extract the ZIP file
            2. Copy `FirebirdODBC.dll` to `C:\Windows\System32` (for 64-bit) or `C:\Windows\SysWOW64` (for 32-bit)
            3. Register the driver using the ODBC Data Source Administrator or installer
            
            ### Linux
            1. Extract the TAR.GZ file
            2. Copy `libOdbcFb.so` to `/usr/local/lib/odbc/`
            3. Register the driver in `/etc/odbcinst.ini`
            
            ## Changes
            See [ChangeLog](https://github.com/${{ github.repository }}/blob/master/ChangeLog_v3.0) for details.

  build-windows:
    needs: create-release
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DBUILD_TESTING=OFF
      
    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}
      
    - name: Package Windows Build
      shell: powershell
      run: |
        $packageDir = "${{github.workspace}}/package-windows"
        New-Item -ItemType Directory -Path $packageDir -Force | Out-Null
        
        # Copy DLL
        Copy-Item "${{github.workspace}}/build/${{env.BUILD_TYPE}}/FirebirdODBC.dll" -Destination $packageDir
        
        # Copy lib if exists
        if (Test-Path "${{github.workspace}}/build/${{env.BUILD_TYPE}}/FirebirdODBC.lib") {
          Copy-Item "${{github.workspace}}/build/${{env.BUILD_TYPE}}/FirebirdODBC.lib" -Destination $packageDir
        }
        
        # Copy README and license files
        Copy-Item "${{github.workspace}}/README.md" -Destination $packageDir -ErrorAction SilentlyContinue
        Copy-Item "${{github.workspace}}/ChangeLog_v3.0" -Destination $packageDir -ErrorAction SilentlyContinue
        
        # Create ZIP
        Compress-Archive -Path "$packageDir/*" -DestinationPath "${{github.workspace}}/firebird-odbc-driver-windows-x64.zip"
        
    - name: Upload Windows Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./firebird-odbc-driver-windows-x64.zip
        asset_name: firebird-odbc-driver-windows-x64-v${{ needs.create-release.outputs.version }}.zip
        asset_content_type: application/zip

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unixodbc unixodbc-dev firebird-dev
        
    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DBUILD_TESTING=OFF
      
    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} -- -j$(nproc)
      
    - name: Package Linux Build
      run: |
        packageDir="${{github.workspace}}/package-linux"
        mkdir -p "$packageDir"
        
        # Copy shared library
        cp ${{github.workspace}}/build/libOdbcFb.so "$packageDir/"
        
        # Copy IscDbc library if built separately
        if [ -f "${{github.workspace}}/build/IscDbc/libIscDbc.a" ]; then
          cp ${{github.workspace}}/build/IscDbc/libIscDbc.a "$packageDir/"
        fi
        
        # Copy README and license files
        cp ${{github.workspace}}/README.md "$packageDir/" 2>/dev/null || true
        cp ${{github.workspace}}/ChangeLog_v3.0 "$packageDir/" 2>/dev/null || true
        
        # Create sample odbcinst.ini
        cat > "$packageDir/odbcinst.ini.sample" << EOF
        [Firebird ODBC Driver]
        Description = Firebird ODBC Driver
        Driver = /usr/local/lib/odbc/libOdbcFb.so
        Setup = /usr/local/lib/odbc/libOdbcFb.so
        FileUsage = 1
        EOF
        
        # Create TAR.GZ
        cd "$packageDir"
        tar -czf "${{github.workspace}}/firebird-odbc-driver-linux-x64.tar.gz" *
        
    - name: Upload Linux Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./firebird-odbc-driver-linux-x64.tar.gz
        asset_name: firebird-odbc-driver-linux-x64-v${{ needs.create-release.outputs.version }}.tar.gz
        asset_content_type: application/gzip
